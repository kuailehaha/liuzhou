# 基于 MCTS 的强化学习六洲棋 AI 系统实现

本项目聚焦传统棋类“六洲棋”的智能对弈系统，涵盖规则建模、MCTS 强化学习训练与人机对战系统实现。

[六洲棋][1]是广泛分布于中国北方的一种传统棋类。该棋类规则各地不一，仅以山东中部地方规则作为实现标准。具体规则叙述见[规则文档](./rule_description.md) 


[1]: https://zh.wikipedia.org/wiki/%E6%96%B9%E6%A3%8B


---

# 规则说明（Rules）

本文档记录了在重构后（将每个动作拆分为原子阶段）所采用的最新规则集。
以下内容取代了旧版本中将多个决策捆绑为单个动作的描述。

---

## 🎮 游戏概述（Game Overview）

* **棋盘**：6 × 6 网格（共 36 个交叉点）。
* **棋子**：两种颜色，`BLACK`（黑）与 `WHITE`（白），每方初始各有 18 枚棋子。
* **目标**：通过吃子移除对方所有棋子。
  如果在限定步数内双方都未能达成此目标，游戏以平局结束。

---

## ⚙️ 阶段结构（原子动作）

游戏在任意时刻都处于下列阶段之一。
每个阶段会持续到所有待处理的子任务完成后，才会交由下一位玩家或进入下一阶段。

---

### 1️⃣ `PLACEMENT`（落子阶段）

* 当前玩家在一个**空的交叉点**上放置一枚棋子，
  但不能放在目前被对方标记的位置上。
* 放置完成后，检查新棋子（若其位置之前未被标记）是否形成以下结构：

  * **正方形**：2×2 方块 → 生成 **1 个** 对方棋子标记任务；
  * **直线**：同行或同列 6 枚棋子（忽略标记棋） → 生成 **2 个** 对方棋子标记任务。
* 若存在待处理标记 → 进入 `MARK_SELECTION` 阶段；
  否则：

  * 若棋盘已满 → 进入 `REMOVAL` 阶段；
  * 若未满 → 轮到对手，继续 `PLACEMENT`。

---

### 2️⃣ `MARK_SELECTION`（标记选择阶段）

* 逐个处理待处理的标记任务。
* 当前玩家为每个待标记任务选择一个合法的对方棋子：

  * 合法目标为**未被标记的对方棋子**；
  * 当存在未构成方块/直线的对方棋时，**优先选择这些棋子**。
* 当所有标记任务完成后：

  * 若棋盘已满 → 进入 `REMOVAL`；
  * 否则交换玩家并返回 `PLACEMENT`。

---

### 3️⃣ `REMOVAL`（移除阶段）

* 若有被标记的棋子 → **同时移除双方所有被标记的棋子**，
  然后进入 `MOVEMENT` 阶段，由 `WHITE` 先行。
* 若没有标记（棋盘填满但无触发标记），则进入 **强制移除序列**（`FORCED_REMOVAL`）：

  1. `WHITE` 先移除一枚不属于方块/直线结构的 `BLACK` 棋子；
  2. 然后 `BLACK` 移除一枚符合同样规则的 `WHITE` 棋子；
  3. 随后进入 `MOVEMENT` 阶段，由 `WHITE` 先行。

---

### 4️⃣ `MOVEMENT`（移动阶段）

* 当前玩家选择并移动自己的一枚棋子，沿**正交方向**（上下左右）移动一步至相邻空位。
* 每次移动后检查是否形成新结构：

  * 方块 → 待捕获数 +1；
  * 直线 → 待捕获数 +2。
* 若存在待捕获任务 → 进入 `CAPTURE_SELECTION`；
  否则交换玩家并继续 `MOVEMENT`。
* **无可移动规则（No-move rule）**：
  若玩家无合法移动，则可以移除一枚不在方块/直线中的对方棋（若无“普通”棋，则任意移除一枚）。
  该操作通过特殊动作 `no_moves_remove` 实现，随后进入 `CAPTURE_SELECTION` 阶段由对方执行**反移除**。

---

### 5️⃣ `CAPTURE_SELECTION`（吃子选择阶段）

* 逐个执行待捕获任务。
* 合法目标与标记阶段一致：优先移除未构成方块/直线的对方棋。
* 每次吃子立即从棋盘移除。
* 若对方棋子全部被移除 → 当前玩家立即获胜。
  否则当所有捕获完成后 → 交换玩家并返回 `MOVEMENT`。

---

### 6️⃣ `COUNTER_REMOVAL`（反移除阶段）

* 仅在执行 `no_moves_remove` 动作后触发。
* 由对手（之前无法行动的一方）移除刚才行动玩家的一枚棋子，遵循相同合法性规则。
* 反移除完成后，若该玩家仍有棋子，则返回 `MOVEMENT` 阶段并交回回合。

---

## 🏁 游戏结束条件（End-of-Game Conditions）

* **吃子胜利**：若某次吃子（包括反移除）使对方棋子全部消失，则当前玩家立即获胜。
* **步数上限平局**：自对弈和训练脚本设定最大步数为 **200 步**。
  若达到上限仍无人获胜，则判定平局（双方得分为 0）。
  此限制用于防止无限循环，可根据需要调整。
* **无合法动作**：若 `generate_all_legal_moves` 返回空列表，则该玩家判负（通常意味着无子可下或早期阶段无法落子）。

---

## 📘 附加说明（Additional Notes）

* 被标记的棋子会在阶段 1（落子阶段）中保留在棋盘上，直到后续的 `REMOVAL` 阶段才被移除。
  被标记棋不可用于形成新的方块或直线。
* 当落子阶段结束且没有任何标记时，必须先执行**强制移除**，再进入移动阶段。
* “无可移动”与“反移除”机制可防止僵局：若某方完全阻挡对手，则给予对手一次移除机会，随后执行反移除，再恢复正常回合。
* 实现层面上，每个 `GameState` 都维护**待标记数**与**待捕获数**，
  确保在 `MARK_SELECTION` 与 `CAPTURE_SELECTION` 阶段中，每次仅处理一个原子任务。

---

该规则集与当前代码逻辑（`rule_engine.py`、`move_generator.py`、以及 Monte Carlo 搜索模块）一致。
在编写测试、调试游戏逻辑或将引擎移植到其他语言时，请以此文档为权威参考。

---

## 📂 代码结构（Code Structure）

---

### 🧠 核心游戏逻辑（Core Game Logic）

* **`src/game_state.py`** —— 定义 `GameState` 容器、阶段枚举（phase enum）、玩家枚举（player enum）以及辅助方法（如复制、统计棋子数量、待标记/待捕获计数器等）。
  这是全局使用的**标准游戏状态快照**。

* **`src/rule_engine.py`** —— 实现每个原子阶段的状态转换逻辑：落子、标记选择、移除、移动、捕获选择、强制移除、反移除等。
  同时包含形状检测逻辑（`detect_shape_formed`、`is_piece_in_shape`）以及兼容旧代码的封装函数（`apply_move_phase1/3`）。

* **`src/move_generator.py`** —— 生成当前阶段的合法动作（并可直接执行）。
  调度对应的 rule engine 函数，保持对外接口 `generate_all_legal_moves` / `apply_move` 的稳定性，供 MCTS 与训练循环使用。

---

### 🧩 学习与搜索（Learning & Search）

* **`src/neural_network.py`** —— 实现 AlphaZero 风格的网络（包含三个策略头 + 一个价值头）：`pos1` 负责落子/移动起点选择，`pos2` 负责移动终点，`mark_capture` 统一负责各类提子/吃子/标记目标的定位。模块还提供张量转换工具与 `get_move_probabilities` 方法。
  是训练与 MCTS 搜索的核心模块。

* **`src/mcts.py`** —— Monte Carlo 树搜索实现。
  使用神经网络提供先验概率与价值估计，处理搜索模拟、日志记录，并将搜索结果转换为可执行的动作分布。

* **`src/train.py`** —— 自博弈与训练循环的调度器。
  负责生成对局、收集 `(state, policy, value)` 样本、训练网络、管理检查点（checkpoint）并执行评估对局。

* **`src/evaluate.py`** —— 工具模块，用于让模型与基线（随机代理或历史最优模型）对战进行离线评估。

---

### 🤖 智能体、测试与工具（Agents, Tests, Utilities）

* **`src/random_agent.py`** —— 基线智能体，从当前合法动作中均匀采样，用于评估与调试。

* **`tests/random_agent/test_random_agent_debug.py` / `tests/random_agent/test_random_agent_enhanced.py`** —— 轻量级冒烟测试，用于验证在规则重构后随机对局是否能无异常地运行完整流程。

* **`tests/test_mcts.py`** —— 针对 MCTS 展开与回传机制的单元测试，使用虚拟模型与张量。

* **`run.py` / `tests/random_agent/run_tests.py`** —— 在训练循环之外运行实验或批量测试的入口文件。

* **`tests/random_agent/README.md`** —— 说明可用自动化测试及其扩展方式的文档。

* **`AGENT.md.bak`、`dev`、`rewrite.md`** —— 历史记录与重构过程中的草稿文件，仅作参考保留。

---

### 🗂️ 项目目录结构（Project Layout, Top Level）

* **`checkpoints_eval_run/`** —— 默认存放训练检查点目录（最佳模型与最新模型权重）。
* **`README_zh.md`** —— 中文版规则文档（编写中）。更新文档时应保持中英文版同步。
